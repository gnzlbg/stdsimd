#!/bin/bash

set -e

cd /qemu/init
cp -f $1 prog
find . | cpio --create --format='newc' --quiet | gzip > ../initrd.gz
cd ..

timeout 30s qemu-system-aarch64 \
  -m 1024 \
  -nographic \
  -kernel kernel \
  -initrd initrd.gz \
  -machine virt \
  -cpu cortex-a57 \
  -append init=/prog > output || true

# remove kernel messages
tr -d '\r' < output | egrep -v '^\['

grep PASSED output > /dev/null